# vLLM Nemotron 3 Nano 30B A3B FP8 Deployment for microk8s
# Deploys nvidia/NVIDIA-Nemotron-3-Nano-30B-A3B-FP8 using ghcr.io/elizabetht/token-labs/vllm-serve:v0.4.0
# Exposes NodePort 30567 for external access

apiVersion: apps/v1
kind: Deployment
metadata:
  name: vllm-nemotron-nano-30b
  namespace: spellingbee
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels: { app: vllm-nemotron-nano-30b }
  template:
    metadata:
      labels: { app: vllm-nemotron-nano-30b }
    spec:
      runtimeClassName: nvidia
      nodeSelector:
        nvidia.com/gpu.product: NVIDIA-GB10
      containers:
        - name: vllm
          image: ghcr.io/elizabetht/token-labs/vllm-serve:v0.4.0
          ports:
            - containerPort: 5567
          env:
            - name: HF_TOKEN
              valueFrom:
                secretKeyRef:
                  name: hf-token
                  key: token
            - name: HUGGING_FACE_HUB_TOKEN
              valueFrom:
                secretKeyRef:
                  name: hf-token
                  key: token
            - name: FLASHINFER_DISABLE_VERSION_CHECK
              value: "1"
          resources:
            limits:
              nvidia.com/gpu: 1
          args:
            - "nvidia/NVIDIA-Nemotron-3-Nano-30B-A3B-FP8"
            - "--trust-remote-code"
            - "--gpu-memory-utilization"
            - "0.3"
            - "--attention-backend"
            - "FLASHINFER"
            - "--port"
            - "5567"
          volumeMounts:
            - name: hf-cache
              mountPath: /root/.cache/huggingface
      volumes:
        - name: hf-cache
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: vllm-nemotron-nano-30b
  namespace: spellingbee
spec:
  type: NodePort
  selector: { app: vllm-nemotron-nano-30b }
  ports:
    - name: http
      port: 5567
      targetPort: 5567
      nodePort: 30567
